require('dotenv').config()
const { Telegraf, Markup } = require('telegraf')
const { Pool } = require('pg')

const bot = new Telegraf(process.env.BOT_TOKEN)

const pool = new Pool({
  connectionString: process.env.DATABASE_URL,
  ssl: { rejectUnauthorized: false }
})

/* -------------------- ุฏุงุฏู ฺฉุงูู ุงุณุชุงู ู ุดูุฑุณุชุงู -------------------- */

const provinces = {
  "ุขุฐุฑุจุงุฌุงู ุดุฑู": ["ุชุจุฑุฒ","ูุฑุงุบู","ูุฑูุฏ","ูุงูู","ุงูุฑ","ุณุฑุงุจ","ุจูุงุจ","ููฺฉุงู","ุดุจุณุชุฑ","ฺฉูุจุฑ","ูุฑุณ","ุนุฌุจโุดุฑ","ุจุณุชุงูโุขุจุงุฏ","ูุฑุฒูุงู","ุฎุฏุงุขูุฑู","ุขุฐุฑุดูุฑ","ุงุณฺฉู","ฺุงุฑุงููุงู","ููุฑุงูุฏ"],
  "ุขุฐุฑุจุงุฌุงู ุบุฑุจ": ["ุงุฑููู","ุฎู","ููุงุจุงุฏ","ุจูฺฉุงู","ูุงูุฏูุขุจ","ุณููุงุณ","ููุฏู","ูพุฑุงูุดูุฑ","ุดุงููโุฏฺ","ูุงฺฉู","ุชฺฉุงุจ","ฺุงูพุงุฑู","ฺุงูุฏุฑุงู","ูพูุฏุดุช","ุงุดููู","ุณุฑุฏุดุช","ุจุงุฑูู"],
  "ุงุฑุฏุจู": ["ุงุฑุฏุจู","ูพุงุฑุณโุขุจุงุฏ","ูุดฺฏูโุดูุฑ","ุฎูุฎุงู","ฺฏุฑู","ููู","ุจููโุณูุงุฑ","ฺฉูุซุฑ","ูุฑ","ุณุฑุนู","ุงูฺฏูุช"],
  "ุงุตููุงู": ["ุงุตููุงู","ฺฉุงุดุงู","ูุฌูโุขุจุงุฏ","ุฎููโุดูุฑ","ุดุงููโุดูุฑ","ููุงูุฑุฌุงู","ุขุฑุงู ู ุจุฏฺฏู","ูุทูุฒ","ุณูุฑู","ฺฏููพุงฺฏุงู","ุฎูุงูุณุงุฑ","ุดูุฑุถุง","ุฏูุงูุงู","ูุฑุฏู","ูุฑุฏููโุดูุฑ","ฺุงุฏฺฏุงู","ุจูุฆู ู ูุงูุฏุดุช","ุชุฑุงู ู ฺฉุฑูู","ุงุฑุฏุณุชุงู","ุจุฑุฎูุงุฑ"],
  "ุงูุจุฑุฒ": ["ฺฉุฑุฌ","ุณุงูุฌุจูุงุบ","ูุธุฑุขุจุงุฏ","ุทุงููุงู","ุงุดุชูุงุฑุฏ","ูุฑุฏุณ"],
  "ุงูุงู": ["ุงูุงู","ุฏููุฑุงู","ุงูุงู","ุขุจุฏุงูุงู","ุฏุฑูโุดูุฑ","ฺุฑุฏุงูู","ููฺฉุดุงู","ููุฑุงู","ุจุฏุฑู","ุณุฑูุงู","ูููุงู"],
  "ุจูุดูุฑ": ["ุจูุดูุฑ","ุฏุดุชุณุชุงู","ฺฏูุงูู","ุฏูู","ุชูฺฏุณุชุงู","ุฏุดุช","ฺฉูฺฏุงู","ุนุณููู","ุฌู"],
  "ุชูุฑุงู": ["ุชูุฑุงู","ุฑ","ุดูุฑุงูุงุช","ุงุณูุงูุดูุฑ","ุดูุฑุงุฑ","ูุฑุงูู","ูพุงฺฉุฏุดุช","ุฏูุงููุฏ","ูุฑูุฒฺฉูู","ูุฏุณ","ููุงุฑุฏ","ุฑุจุงุทโฺฉุฑู","ุจูุงุฑุณุชุงู","ูพุฑุฏุณ","ูุฑฺฺฉ"],
  "ฺูุงุฑูุญุงู ู ุจุฎุชุงุฑ": ["ุดูุฑฺฉุฑุฏ","ุจุฑูุฌู","ูุฑุฏฺฏุงู","ูุงุฑุณุงู","ฺฉููุฑูฺฏ","ุงุฑุฏู","ฺฉุงุฑ","ุณุงูุงู","ุจู"],
  "ุฎุฑุงุณุงู ุฌููุจ": ["ุจุฑุฌูุฏ","ูุงุฆูุงุช","ูุฑุฏูุณ","ุทุจุณ","ููุจูุฏุงู","ุณุฑุงุงู","ุณุฑุจุดู","ุฏุฑูุงู","ุฎูุณู","ุฒุฑฺฉูู","ุจุดุฑูู"],
  "ุฎุฑุงุณุงู ุฑุถู": ["ูุดูุฏ","ูุดุงุจูุฑ","ุณุจุฒูุงุฑ","ุชุฑุจุช ุญุฏุฑู","ููฺุงู","ฺฉุงุดูุฑ","ุชุงุจุงุฏ","ุชุฑุจุช ุฌุงู","ฺูุงุฑุงู","ฺฏูุงุจุงุฏ","ุฎูุงู","ุฏุฑฺฏุฒ","ุจุฑุฏุณฺฉู","ูุฑูุฒู","ููโููุงุช","ุฑุดุชุฎูุงุฑ","ุฒุงูู","ุจุงุฎุฑุฒ","ุฎููโุขุจุงุฏ","ุฌุบุชุง","ุฏุงูุฑุฒู","ฺฉูุงุช","ุณุฑุฎุณ","ุทุฑูุจู ุดุงูุฏุฒ","ฺฏูุจูุงุฑ"],
  "ุฎุฑุงุณุงู ุดูุงู": ["ุจุฌููุฑุฏ","ุดุฑูุงู","ุงุณูุฑุงู","ุฌุงุฌุฑู","ฺฏุฑูู","ุฑุงุฒ ู ุฌุฑฺฏูุงู","ูุงุฑูุฌ","ูุงูู ู ุณูููุงู"],
  "ุฎูุฒุณุชุงู": ["ุงููุงุฒ","ุขุจุงุฏุงู","ุฎุฑูุดูุฑ","ุฏุฒููู","ุงูุฏูุดฺฉ","ูุงูุดูุฑ","ุจูุจูุงู","ุงุฐู","ุดุงุฏฺฏุงู","ูุณุฌุฏุณููุงู","ุดูุด","ุดูุดุชุฑ","ุฑุงููุฑูุฒ","ุจุงุบููฺฉ","ุฑุงูุดุฑ","ฺฉุงุฑูู","ุญูุฏู","ููุฒู","ุฏุดุช ุขุฒุงุฏฺฏุงู","ูุงู","ฺฏุชููุฏ","ุงูุฏฺฉุง"],
  "ุฒูุฌุงู": ["ุฒูุฌุงู","ุงุจูุฑ","ุฎุฑูุฏุฑู","ุฎุฏุงุจูุฏู","ุทุงุฑู","ูุงููุดุงู","ุงุฌุฑูุฏ","ุณูุทุงูู"],
  "ุณููุงู": ["ุณููุงู","ุดุงูุฑูุฏ","ุฏุงูุบุงู","ฺฏุฑูุณุงุฑ","ููุฏุดูุฑ","ุขุฑุงุฏุงู","ุณุฑุฎู","ูุงู"],
  "ุณุณุชุงู ู ุจููฺุณุชุงู": ["ุฒุงูุฏุงู","ฺุงุจูุงุฑ","ุงุฑุงูุดูุฑ","ุฒุงุจู","ุฎุงุด","ุณุฑุงูุงู","ุณุฑุจุงุฒ","ฺฉูุงุฑฺฉ","ูฺฉโุดูุฑ","ุฏูฺฏุงู","ูููุฌ","ูุงููู","ูุฑููุฏ","ูุฑุฌุงูู","ูุตุฑููุฏ","ุชูุชุงู","ุณุจ ู ุณูุฑุงู","ููุฑุณุชุงู"],
  "ูุงุฑุณ": ["ุดุฑุงุฒ","ูุฑูุฏุดุช","ฺฉุงุฒุฑูู","ูุณุง","ุฏุงุฑุงุจ","ูุงุฑุณุชุงู","ุฌูุฑู","ุขุจุงุฏู","ุงุณุชูุจุงู","ุงููุฏ","ุณูพุฏุงู","ูโุฑุฒ","ูุงูุฑุฏ","ููุฑ","ฺฏุฑุงุด","ุฎุฑุงูู","ุฒุฑูโุฏุดุช","ูพุงุณุงุฑฺฏุงุฏ","ุฑุณุชู","ุจุถุง","ฺฉูุงุฑ","ุฎูุฑ","ุณุฑูุณุชุงู","ุจุฎุชฺฏุงู"],
  "ูุฒูู": ["ูุฒูู","ุงูุจุฑุฒ","ุชุงฺฉุณุชุงู","ุขุจฺฉ","ุจูุฆูโุฒูุฑุง","ุขูุฌ"],
  "ูู": ["ูู"],
  "ฺฉุฑุฏุณุชุงู": ["ุณููุฏุฌ","ุณูุฒ","ูุฑูุงู","ุจุงูู","ูุฑูู","ฺฉุงูุงุฑุงู","ุจุฌุงุฑ","ุฏูฺฏูุงู","ุฏูุงูุฏุฑู","ุณุฑูุขุจุงุฏ"],
  "ฺฉุฑูุงู": ["ฺฉุฑูุงู","ุฑูุณูุฌุงู","ุฌุฑูุช","ุจู","ุณุฑุฌุงู","ุฒุฑูุฏ","ุจุฑุฏุณุฑ","ุฑูุฏุจุงุฑ ุฌููุจ","ุนูุจุฑุขุจุงุฏ","ฺฉูููุฌ","ููุนูโฺฏูุฌ","ุฑฺฏุงู","ุฑุงูุฑ","ููุฑุฌ","ูุฑูุงุดุฑ","ุงุฑุฒูุฆู","ฺฉููุจูุงู","ุฑุงุจุฑ","ุจุงูุช","ูููุฌุงู","ุงูุงุฑ"],
  "ฺฉุฑูุงูุดุงู": ["ฺฉุฑูุงูุดุงู","ุงุณูุงูโุขุจุงุฏ ุบุฑุจ","ูพุงูู","ฺฉูฺฏุงูุฑ","ุณููุฑ","ูุฑุณู","ุตุญูู","ุฌูุงูุฑูุฏ","ุฑูุงูุณุฑ","ุฏุงูุงูู","ุณุฑูพู ุฐูุงุจ","ฺฏูุงูุบุฑุจ","ุซูุงุซ ุจุงุจุงุฌุงู","ูุตุฑุดุฑู"],
  "ฺฉูฺฏููู ู ุจูุฑุงุญูุฏ": ["ุงุณูุฌ","ฺฏฺุณุงุฑุงู","ุฏูุฏุดุช","ูฺฉฺฉ","ุจุงุดุช","ฺุฑุงู","ููุฏู","ูุงุฑฺฏูู"],
  "ฺฏูุณุชุงู": ["ฺฏุฑฺฏุงู","ฺฏูุจุฏฺฉุงููุณ","ุนูโุขุจุงุฏ","ุขูโููุง","ฺฉุฑุฏฺฉู","ุจูุฏุฑุชุฑฺฉูู","ูููุฏุดุช","ฺฏุงูฺฉุด","ฺฉูุงูู","ุขุฒุงุฏุดูุฑ","ุฑุงูุงู","ูุฑุงููโุชูพู","ฺฏูุดุงู"],
  "ฺฏูุงู": ["ุฑุดุช","ุงูุฒู","ูุงูุฌุงู","ููฺฏุฑูุฏ","ุขุณุชุงุฑุง","ุชุงูุด","ุฑูุฏุณุฑ","ูููู","ุตููุนูโุณุฑุง","ุฑุถูุงูุดูุฑ","ุดูุช","ุณุงูฺฉู","ุงููุด","ูุงุณุงู"],
  "ูุฑุณุชุงู": ["ุฎุฑูโุขุจุงุฏ","ุจุฑูุฌุฑุฏ","ุฏูุฑูุฏ","ฺฉููุฏุดุช","ุงูฺฏูุฏุฑุฒ","ุงุฒูุง","ููุฑุขุจุงุฏ","ูพูุฏุฎุชุฑ","ฺฺฏู","ุณูุณูู"],
  "ูุงุฒูุฏุฑุงู": ["ุณุงุฑ","ุจุงุจู","ุขูู","ูุงุฆูโุดูุฑ","ุจูุดูุฑ","ููุดูุฑ","ฺุงููุณ","ุชูฺฉุงุจู","ุฑุงูุณุฑ","ูฺฉุง","ุฌูุจุงุฑ","ุจุงุจูุณุฑ","ูุฑุฏููโฺฉูุงุฑ","ฺฉูุงุฑุฏุดุช","ุนุจุงุณโุขุจุงุฏ","ูุงูุฏูุฑูุฏ","ุณูุงุฏฺฉูู","ุณูุงุฏฺฉูู ุดูุงู","ุณูุฑุบ"],
  "ูุฑฺฉุฒ": ["ุงุฑุงฺฉ","ุณุงูู","ุฎูู","ูุญูุงุช","ุฏูุฌุงู","ุดุงุฒูุฏ","ุชูุฑุด","ุขุดุชุงู","ุฒุฑูุฏู","ุฎูุฏุงุจ"],
  "ูุฑูุฒฺฏุงู": ["ุจูุฏุฑุนุจุงุณ","ููุงุจ","ูุดู","ุจูุฏุฑููฺฏู","ุฌุงุณฺฉ","ุฑูุฏุงู","ุญุงุฌโุขุจุงุฏ","ูพุงุฑุณุงู","ุณุฑฺฉ","ุจุณุชฺฉ","ุฎูุฑ","ุงุจูููุณ"],
  "ููุฏุงู": ["ููุฏุงู","ููุงุฑ","ููุงููุฏ","ุชูุณุฑฺฉุงู","ุงุณุฏุขุจุงุฏ","ุจูุงุฑ","ฺฉุจูุฏุฑุขููฺฏ","ูุงููู","ุฑุฒู","ุฏุฑฺฏุฒู"],
  "ุฒุฏ": ["ุฒุฏ","ูุจุฏ","ุงุฑุฏฺฉุงู","ุจุงูู","ููุฑุฒ","ุงุจุฑฺฉูู","ุชูุช","ุฎุงุชู","ุงุดฺฉุฐุฑ","ุจูุงุจุงุฏ","ูุฑูุณุช"]
}

/* -------------------- ุงุจุฒุงุฑ ฺฉุจูุฑุฏ -------------------- */

function buildKeyboard(arr, perRow = 3) {
  const rows = []
  for (let i = 0; i < arr.length; i += perRow) {
    rows.push(arr.slice(i, i + perRow))
  }
  return Markup.keyboard(rows).resize()
}

function ageKeyboard() {
  const ages = []
  for (let i = 19; i <= 69; i++) {
    ages.push(String(i))
  }
  return buildKeyboard(ages, 4)
}

function normalizeNumber(input) {
  return input.replace(/[ฐ-น]/g, d => 'ฐฑฒณดตถทธน'.indexOf(d)).trim()
}

/* -------------------- ุณุดู -------------------- */

async function ensureUser(id) {
  await pool.query(
    `INSERT INTO app_users (telegram_user_id)
     VALUES ($1)
     ON CONFLICT (telegram_user_id) DO NOTHING`,
    [id]
  )
}

async function getSession(id) {
  const { rows } = await pool.query(
    `SELECT * FROM flow_sessions WHERE telegram_user_id = $1`,
    [id]
  )
  return rows[0]
}

async function saveSession(id, step, state) {
  await pool.query(
    `INSERT INTO flow_sessions (telegram_user_id, current_step, state)
     VALUES ($1, $2, $3)
     ON CONFLICT (telegram_user_id)
     DO UPDATE SET current_step = EXCLUDED.current_step,
                   state = EXCLUDED.state`,
    [id, step, state]
  )
}

async function clearSession(id) {
  await pool.query(
    `DELETE FROM flow_sessions WHERE telegram_user_id = $1`,
    [id]
  )
}

/* -------------------- ุฌุฑุงู ุจุงุช -------------------- */

bot.start(async (ctx) => {
  const id = ctx.from.id
  await ensureUser(id)
  await saveSession(id, 'ask_name', {})
  ctx.reply('ุณูุงู ๐\nุงุณูุช ฺูุ', Markup.removeKeyboard())
})

bot.on('text', async (ctx) => {
  const id = ctx.from.id
  const text = ctx.message.text.trim()

  try {
    const session = await getSession(id)
    if (!session) return ctx.reply('ุงูู /start ุฑู ุจุฒู.')

    const state = session.state || {}
    const step = session.current_step

    switch (step) {

      case 'ask_name':
        state.name = text
        await saveSession(id, 'ask_province', state)
        return ctx.reply('ุงุฒ ฺฉุฏูู ุงุณุชุงูุ', buildKeyboard(Object.keys(provinces), 2))

      case 'ask_province':
        if (!provinces[text]) return ctx.reply('ฺฉ ุงุฒ ฺฏุฒููโูุง ุฑู ุงูุชุฎุงุจ ฺฉู.')
        state.province = text
        await saveSession(id, 'ask_city', state)
        return ctx.reply('ุดูุฑุช ุฑู ุงูุชุฎุงุจ ฺฉู:', buildKeyboard(provinces[text], 2))

      case 'ask_city':
        if (!provinces[state.province].includes(text))
          return ctx.reply('ุงุฒ ูุณุช ุงูุชุฎุงุจ ฺฉู.')
        state.city = text
        await saveSession(id, 'ask_age', state)
        return ctx.reply('ฺูุฏ ุณุงูุชูุ', ageKeyboard())

      case 'ask_age':
        const age = Number(normalizeNumber(text))
        if (isNaN(age) || age < 19 || age > 69)
          return ctx.reply('ุณู ูุนุชุจุฑ ุงูุชุฎุงุจ ฺฉู.')
        state.age = age
        await saveSession(id, 'confirm', state)
        return ctx.reply(
`ุงุทูุงุนุงุชุช:
ุงุณู: ${state.name}
ุงุณุชุงู: ${state.province}
ุดูุฑ: ${state.city}
ุณู: ${state.age}

ุชุงุฏ ูโฺฉูุ`,
          buildKeyboard(['ุชุงุฏ โ','ุงุตูุงุญ โ'],1)
        )

      case 'confirm':
        if (text === 'ุชุงุฏ โ') {
          await pool.query(
            `INSERT INTO test_submissions(name, province, city, age)
             VALUES($1,$2,$3,$4)`,
            [state.name, state.province, state.city, state.age]
          )
          await clearSession(id)
          return ctx.reply('ุซุจุช ุดุฏ โ', Markup.removeKeyboard())
        }

        if (text === 'ุงุตูุงุญ โ') {
          await saveSession(id, 'ask_name', {})
          return ctx.reply('ุฏูุจุงุฑู ุดุฑูุน ฺฉูู.\nุงุณูุช ฺูุ', Markup.removeKeyboard())
        }

        return ctx.reply('ฺฉ ุงุฒ ฺฏุฒููโูุง ุฑู ุงูุชุฎุงุจ ฺฉู.')
    }

  } catch (err) {
    console.error(err)
    ctx.reply('ุฎุทุง ุฏุฑ ุฐุฎุฑู ุงุทูุงุนุงุช โ')
  }
})

bot.launch()
console.log('Bot is running...')